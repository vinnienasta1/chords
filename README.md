# Chords — развертывание и архитектура

Проект состоит из трёх сервисов, которые должны работать совместно:

1) **Сайт (PHP)** — фронтенд/админка, общается с БД и Telegram‑ботом.  
2) **База данных (MySQL/MariaDB)** — хранит пользователей, песни, сеты и заявки верификации.  
3) **Telegram‑бот (Python + Flask API)** — верификация пользователей, приём/хеширование паролей, рассылка.

## Минимальные требования по сети
- Сайт -> БД: порт 3306 (MySQL/MariaDB).  
- Бот -> БД: порт 3306.  
- Сайт -> Бот: порт 8080 (Flask API).  
- Ограничьте доступ к 8080 и 3306 только внутренней подсетью (firewall / security groups).

## Подготовка базы

### Автоматическая установка (рекомендуется)

Для быстрой установки MariaDB сервера с готовой структурой базы данных используйте скрипт `setup-db-server.sh`:

```bash
sudo bash setup-db-server.sh
```

**Что делает скрипт:**
- Проверяет, что система — Ubuntu
- Проверяет наличие уже установленных БД пакетов
- Запрашивает необходимые данные (пароли, имя БД, пользователь и т.д.)
- Устанавливает обновления системы
- Устанавливает и настраивает MariaDB
- Создает базу данных `chords` со всеми таблицами, индексами и связями
- Создает пользователя БД с необходимыми правами
- Опционально устанавливает phpMyAdmin для управления БД
- Выводит полный отчет с учетными данными и инструкциями

**Особенности:**
- База данных создается по шаблону проекта со всеми необходимыми таблицами:
  - `songs` — песни
  - `chords` — аккорды
  - `setlists` — сет-листы
  - `setlist_items` — элементы сет-листа
  - `setlist_comments` — комментарии к сет-листам
  - `users` — пользователи
- Все внешние ключи, индексы и ограничения создаются автоматически
- Без личных данных — создается только структура
- Поддержка удаленных подключений (опционально)

### Ручная установка

1. Разверните MySQL/MariaDB и создайте БД `chords` и пользователя с правами на неё.  
2. Импортируйте схему из репозитория `chords_db`:  
   ```bash
   mysql -uUSER -pPASSWORD chords < schema.sql
   ```  
   Ссылка на репозиторий схемы: https://github.com/vinnienasta1/chords_db  
3. Убедитесь, что сервер БД доступен приложению (сайт) и боту по внутренней сети.

## Настройка сайта

### Автоматическая установка (рекомендуется)

Для быстрой установки веб-сайта используйте скрипт `setup-website.sh`:

```bash
sudo bash setup-website.sh
```

**Что делает скрипт:**
- Проверяет, что система — Ubuntu
- Проверяет наличие уже установленных веб-серверов
- Запрашивает необходимые данные:
  - Выбор веб-сервера (Nginx или Apache)
  - Настройки подключения к БД (хост, порт, пользователь, пароль, имя БД)
  - Broadcast Token (BROADCAST_TOKEN)
  - URL Telegram бота API
  - Источник кода сайта (репозиторий, локальный путь или пропуск)
- Устанавливает обновления системы
- Устанавливает веб-сервер (Nginx или Apache) и PHP с необходимыми модулями
- Настраивает веб-сервер для работы с PHP
- Клонирует/копирует код сайта в `/var/www/html`
- Создает файл конфигурации `db.php` из `db.example.php`
- Настраивает PHP-FPM с переменными окружения (BROADCAST_TOKEN, DB_HOST, DB_USER, DB_PASS, DB_NAME)
- Проверяет подключение к базе данных
- Запускает веб-сервер
- Выводит полный отчет с учетными данными и инструкциями

**Особенности:**
- Поддержка Nginx и Apache
- Автоматическая настройка PHP-FPM с переменными окружения
- Автоматическое создание `db.php` из `db.example.php`
- Клонирование из GitHub репозитория или использование локального кода
- Правильная настройка прав доступа к файлам
- Проверка подключения к БД перед завершением

### Ручная установка

1. Склонируйте код: https://github.com/vinnienasta1/chords (`main`).  
2. Создайте `db.php` из `db.example.php`, пропишите хост/порт/пользователя/пароль БД.  
3. В PHP‑FPM (`/etc/php/8.3/fpm/pool.d/www.conf`) добавьте переменную окружения с токеном рассылки:  
   ```
   env[BROADCAST_TOKEN] = "ВАШ_СЕКРЕТ"
   ```  
   Перезагрузите PHP‑FPM.  
4. Убедитесь, что `admin.php` может обращаться к боту по `http://<bot_host>:8080`. При необходимости поправьте URL в коде/конфиге.  
5. Вкладка `admin.php#broadcast` отправляет текст в API бота `/broadcast`; токен должен совпадать с токеном в боте.  
6. Вкладка `admin.php#tg-bot` использует данные бота (эндпоинт/URL) для проверки доступности.

## Настройка Telegram‑бота

### Автоматическая установка (рекомендуется)

Для быстрой установки Telegram бота используйте скрипт `setup-telegram-bot.sh`:

```bash
sudo bash setup-telegram-bot.sh
```

**Что делает скрипт:**
- Проверяет, что система — Ubuntu
- Проверяет наличие Python 3.8+
- Проверяет наличие уже установленного бота
- Запрашивает необходимые данные:
  - Токен Telegram бота (BOT_TOKEN)
  - ID администратора (ADMIN_USER_ID)
  - Настройки подключения к БД (хост, порт, пользователь, пароль, имя БД)
  - Настройки API сервера (хост, порт)
  - URL сайта (SITE_URL)
  - Broadcast Token (BROADCAST_TOKEN)
  - Источник кода бота (репозиторий, локальный путь или пропуск)
- Устанавливает системные зависимости (Python, pip, venv, git)
- Создает структуру проекта в `/opt/telegram-bot`
- Клонирует/копирует код бота (если указан источник)
- Создает виртуальное окружение Python
- Устанавливает Python зависимости (Flask, python-telegram-bot, PyMySQL, bcrypt и др.)
- Создает файл конфигурации `config.py`
- Создает и настраивает systemd сервис
- Проверяет подключение к базе данных
- Запускает бота
- Выводит полный отчет с учетными данными и инструкциями

**Особенности:**
- Автоматическое создание systemd сервиса с автозапуском
- Поддержка клонирования из GitHub репозитория
- Поддержка локальных путей к коду
- Проверка подключения к БД перед запуском
- Автоматическая установка всех необходимых зависимостей
- Гибкая настройка всех параметров через интерактивный интерфейс

### Ручная установка

1. Склонируйте код бота: https://github.com/vinnienasta1/chords_tg (`main`).  
2. Создайте `config.py` из `config.example.py` и заполните:
   - `BOT_TOKEN` — токен Telegram бота.  
   - `BROADCAST_TOKEN` — тот же секрет, что на сайте (PHP‑FPM).  
   - `SITE_URL` — URL сайта (для кнопок).  
   - `DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME` — доступ к БД.  
   - `API_HOST` / `API_PORT` — по умолчанию `0.0.0.0:8080`.  
3. Установите зависимости в виртуальном окружении:  
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```  
4. Запустите (рекомендуется systemd‑юнит) и убедитесь, что порт 8080 доступен сайту.  
5. Бот:
   - Валидирует заявку, запрашивает пароль у пользователя, хеширует через `bcrypt` и пишет в БД (совместимо с `password_verify` в PHP).  
   - Сверяет Telegram username без учёта регистра.  
   - Принимает рассылку на `/broadcast` (требует `BROADCAST_TOKEN`) и шлёт всем подтверждённым пользователям.

## Ключевые тонкости
- **Секреты не хранятся в репозиториях.** `config.py`, `db.php`, реальные токены/пароли — только на серверах.  
- **Одинаковый `BROADCAST_TOKEN`** на сайте (PHP‑FPM env) и в боте.  
- **Firewall**: ограничьте 8080 и 3306 только внутренней сетью, не открывайте наружу.  
- **Часовой пояс/UTC**: следите, чтобы время на всех серверах было синхронизировано — заявки/TTL завязаны на `expires_at`.  
- **Логи**: бот пишет в stdout; PHP — в логи веб‑сервера/PHP‑FPM. Следите за ошибками cURL при рассылке.  
- **Кейсы имён Telegram**: username нормализуется в нижний регистр и без `@` — избежать проблем `Vevins` vs `vevins`.  
- **Бэкапы**: делайте дамп БД отдельно, в git не храните.

## Быстрый чеклист запуска
1. БД поднята, схема импортирована, доступ с сайта и бота есть.  
2. `db.php` создан и указывает на БД.  
3. `BROADCAST_TOKEN` задан в PHP‑FPM и совпадает с ботом.  
4. Бот запущен, видит БД, принимает запросы на 8080.  
5. На сайте открываются вкладки `admin.php#tg-bot` и `admin.php#broadcast`, рассылка возвращает успех.  
6. Телеграм‑логин регистрируется/подтверждается, пароль сохраняется, вход через сайт работает.
